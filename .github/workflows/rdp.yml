name: Windows-RDP-Full-Profile

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-2019
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # 1. Instalam 7zip si unelte necesare
    - name: Instalare Softuri
      run: choco install googlechrome megacmd tailscale 7zip -y

    - name: Configurare RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        # Parola simpla ca sa nu avem probleme la login
        net user runneradmin Start123
        Set-ItemProperty -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System' -Name "DisableLockWorkstation" -Value 1

    - name: Tailscale
      shell: powershell
      run: |
        Start-Service tailscale
        Start-Sleep -Seconds 5
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --accept-routes --accept-dns=false
        $myIp = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4).Trim()
        echo "IP_ADDRESS=$myIp" >> $env:GITHUB_ENV

    # NOTIFICARE START (Text simplu, fara emojis)
    - name: Discord Notificare
      shell: powershell
      run: |
        $msg = @{ content = "RDP ONLINE! `nSe incearca restaurarea profilului... `nIP: ${{ env.IP_ADDRESS }} `nPass: Start123" } | ConvertTo-Json
        Invoke-RestMethod -Uri ${{ secrets.DISCORD_WEBHOOK }} -Method Post -Body $msg -ContentType "application/json"

    # 2. RESTAURARE COMPLETA (Daca exista backup)
    - name: Restaurare Profil
      shell: powershell
      run: |
        $megaDir = Get-ChildItem -Path "C:\Program Files", "C:\Users\runneradmin\AppData\Local" -Filter "MEGAcmd" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
        if ($megaDir) { $env:PATH += ";$megaDir" }
        
        try {
            mega-login ${{ secrets.MEGA_EMAIL }} ${{ secrets.MEGA_PASSWORD }}
            
            Write-Host "Cautare backup pe MEGA..."
            # Incercam descarcarea. Daca e prima rulare, va da o eroare in consola dar merge mai departe.
            mega-get /RDP_Full_Backup/FullProfile.7z C:\FullProfile.7z
            
            if (Test-Path "C:\FullProfile.7z") {
                Write-Host "Backup gasit! Se dezarhiveaza..."
                # Dezarhivam fortat peste userul curent
                & "7z" x "C:\FullProfile.7z" -o"C:\Users\runneradmin\" -aoa -y
                
                $msg = @{ content = "RESTAURARE REUSITA! Profilul tau a fost incarcat." } | ConvertTo-Json
                Invoke-RestMethod -Uri ${{ secrets.DISCORD_WEBHOOK }} -Method Post -Body $msg -ContentType "application/json"
            } else {
                Write-Host "Nu exista backup inca (Prima rulare). Se va crea unul in 10 minute."
            }
        } catch { Write-Host "Eroare neasteptata la restaurare (ignorata)." }

    # 3. LOOP BACKUP TOTAL (La fiecare 10 minute)
    - name: Loop Backup Total
      shell: powershell
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        $count = 0
        while($count -lt 66) {
            # Asteptam 10 minute (600 secunde) intre salvari
            Start-Sleep -Seconds 600
            $count++
            
            try {
                if (Test-Path "C:\FullProfile.7z") { Remove-Item "C:\FullProfile.7z" -Force }
                
                # Arhivare User (fara fisiere temporare inutile)
                & "7z" a "C:\FullProfile.7z" "C:\Users\runneradmin\*" -mx1 -xr!AppData\Local\Temp -xr!AppData\Local\Microsoft\Windows\INetCache -xr!AppData\Local\MEGAcmd
                
                mega-rm /RDP_Full_Backup/FullProfile.7z
                # Parametrul -c creeaza folderul daca nu exista
                mega-put -c C:\FullProfile.7z /RDP_Full_Backup/
                
                $alert = @{ content = "[BACKUP TOTAL] Salvarea nr. $count completa." } | ConvertTo-Json
                Invoke-RestMethod -Uri ${{ secrets.DISCORD_WEBHOOK }} -Method Post -Body $alert -ContentType "application/json"
                
            } catch { Write-Host "Eroare la backup." }
        }
        gh api repos/${{ github.repository }}/dispatches -f event_type=restart_rdp
