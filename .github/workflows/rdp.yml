name: Windows-RDP-Final-V2

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-2019
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # 1. Instalam 7zip si unelte
    - name: Instalare Softuri
      run: choco install googlechrome megacmd tailscale 7zip -y

    - name: Configurare RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        # Parola simpla: Start123
        net user runneradmin Start123
        Set-ItemProperty -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System' -Name "DisableLockWorkstation" -Value 1

    - name: Tailscale
      shell: powershell
      run: |
        Start-Service tailscale
        Start-Sleep -Seconds 5
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --accept-routes --accept-dns=false
        $myIp = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4).Trim()
        echo "IP_ADDRESS=$myIp" >> $env:GITHUB_ENV

    # Notificare Discord (Fara Emojis ca sa nu dea eroare JSON)
    - name: Discord Notificare
      shell: powershell
      run: |
        $msg = @{ content = "RDP ONLINE! `nSe verifica existenta backup-ului... `nIP: ${{ env.IP_ADDRESS }} `nPass: Start123" } | ConvertTo-Json
        Invoke-RestMethod -Uri ${{ secrets.DISCORD_WEBHOOK }} -Method Post -Body $msg -ContentType "application/json"

    # 2. RESTAURARE (CU PROTECTIE ANTI-CRASH)
    - name: Restaurare Profil
      shell: powershell
      run: |
        # Configurare MEGA in Path
        $megaDir = Get-ChildItem -Path "C:\Program Files", "C:\Users\runneradmin\AppData\Local" -Filter "MEGAcmd" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
        if ($megaDir) { $env:PATH += ";$megaDir" }
        
        # Login
        try { mega-login ${{ secrets.MEGA_EMAIL }} ${{ secrets.MEGA_PASSWORD }} } catch { Write-Host "Login error/Already logged in" }

        Write-Host "Incercare descarcare backup..."
        
        # --- SECTIUNEA ANTI-CRASH ---
        # Folosim un truc: Daca mega-get da eroare, prindem eroarea si nu lasam GitHub sa inchida serverul
        try {
            mega-get /RDP_Full_Backup/FullProfile.7z C:\FullProfile.7z
        } catch {
            Write-Host "Comanda mega-get a dat o eroare, dar continuam."
        }

        # Verificam manual daca fisierul a aparut
        if (Test-Path "C:\FullProfile.7z") {
            Write-Host "Backup gasit! Se dezarhiveaza..."
            & "7z" x "C:\FullProfile.7z" -o"C:\Users\runneradmin\" -aoa -y
            
            $msg = @{ content = "RESTAURARE REUSITA! Profilul tau a fost incarcat." } | ConvertTo-Json
            Invoke-RestMethod -Uri ${{ secrets.DISCORD_WEBHOOK }} -Method Post -Body $msg -ContentType "application/json"
        } else {
            Write-Host "NU EXISTA BACKUP INCA. E ok, mergem mai departe!"
        }

        # FORTAM SUCCESUL: Spunem GitHub-ului ca totul e bine (Exit Code 0)
        $global:LastExitCode = 0
        exit 0

    # 3. LOOP BACKUP TOTAL (La fiecare 10 minute)
    - name: Loop Backup Total
      shell: powershell
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        $count = 0
        while($count -lt 300) {
            # Asteptam 10 minute (600 secunde)
            Start-Sleep -Seconds 600
            $count++
            
            try {
                if (Test-Path "C:\FullProfile.7z") { Remove-Item "C:\FullProfile.7z" -Force }
                
                # Arhivam Userul (fara fisiere Temp inutile)
                & "7z" a "C:\FullProfile.7z" "C:\Users\runneradmin\*" -mx1 -xr!AppData\Local\Temp -xr!AppData\Local\Microsoft\Windows\INetCache -xr!AppData\Local\MEGAcmd
                
                # Stergem vechiul backup de pe MEGA
                mega-rm /RDP_Full_Backup/FullProfile.7z
                
                # Urcam noul backup (-c creeaza folderul obligatoriu)
                mega-put -c C:\FullProfile.7z /RDP_Full_Backup/
                
                $alert = @{ content = "[BACKUP TOTAL] Salvarea nr. $count completa." } | ConvertTo-Json
                Invoke-RestMethod -Uri ${{ secrets.DISCORD_WEBHOOK }} -Method Post -Body $alert -ContentType "application/json"
                
            } catch { Write-Host "Eroare temporara la backup..." }
        }
