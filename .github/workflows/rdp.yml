name: Windows-RDP-Total

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-2019
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Instalare Softuri
      run: choco install googlechrome megacmd tailscale -y

    - name: Configurare RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        # Am pus o parola simpla fara semne speciale ca sa mearga sigur
        net user runneradmin Start123
        Set-ItemProperty -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System' -Name "DisableLockWorkstation" -Value 1

    - name: Tailscale
      shell: powershell
      run: |
        Start-Service tailscale
        Start-Sleep -Seconds 5
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --accept-routes --accept-dns=false
        $myIp = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4).Trim()
        echo "IP_ADDRESS=$myIp" >> $env:GITHUB_ENV

    - name: Discord Notificare (Cu Parola)
      shell: powershell
      run: |
        # Aici am adaugat Userul si Parola in mesaj
        $msg = @{ content = "âœ… **RDP ONLINE!** `nðŸ“¡ IP: ${{ env.IP_ADDRESS }} `nðŸ‘¤ User: runneradmin `nðŸ”‘ Pass: Start123" } | ConvertTo-Json
        Invoke-RestMethod -Uri ${{ secrets.DISCORD_WEBHOOK }} -Method Post -Body $msg -ContentType "application/json"

    - name: Restaurare si Loop
      shell: powershell
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Configurare MEGA
        $megaDir = Get-ChildItem -Path "C:\Program Files", "C:\Users\runneradmin\AppData\Local" -Filter "MEGAcmd" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
        if ($megaDir) { $env:PATH += ";$megaDir" }
        
        # Login MEGA
        try {
            mega-login ${{ secrets.MEGA_EMAIL }} ${{ secrets.MEGA_PASSWORD }}
            mega-get /RDP_Full_Backup/Desktop C:\Users\runneradmin\Desktop
            mega-get /RDP_Full_Backup/AppData C:\Users\runneradmin\AppData\Roaming
        } catch { Write-Host "Nu s-a putut conecta la MEGA. VerificÄƒ parola." }

        # Loop infinit (5 ore)
        $count = 0
        while($count -lt 66) {
            Start-Sleep -Seconds 300
            $count++
            try {
                mega-rm -r /RDP_Full_Backup/Desktop
                mega-rm -r /RDP_Full_Backup/AppData
                mega-put C:\Users\runneradmin\Desktop /RDP_Full_Backup/
                mega-put C:\Users\runneradmin\AppData\Roaming /RDP_Full_Backup/
            } catch { Write-Host "Sync skip" }
        }
        gh api repos/${{ github.repository }}/dispatches -f event_type=restart_rdp
