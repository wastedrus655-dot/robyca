name: Windows-RDP-V5-FinalFix

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-2019
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # 1. Instalam 7zip si unelte
    - name: Instalare Softuri
      run: choco install googlechrome megacmd tailscale 7zip -y

    - name: Configurare RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        net user runneradmin Start123
        Set-ItemProperty -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System' -Name "DisableLockWorkstation" -Value 1

    - name: Tailscale
      shell: powershell
      run: |
        Start-Service tailscale
        Start-Sleep -Seconds 5
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --accept-routes --accept-dns=false
        $myIp = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4).Trim()
        echo "IP_ADDRESS=$myIp" >> $env:GITHUB_ENV

    # Notificare Discord
    - name: Discord Notificare
      shell: powershell
      run: |
        $msg = @{ content = "RDP ONLINE! `nIP: ${{ env.IP_ADDRESS }} `nPass: Start123" } | ConvertTo-Json
        Invoke-RestMethod -Uri ${{ secrets.DISCORD_WEBHOOK }} -Method Post -Body $msg -ContentType "application/json"

    # 2. RESTAURARE
    - name: Restaurare Profil
      shell: powershell
      run: |
        $ErrorActionPreference = 'Continue'
        # Activam MEGA
        $megaDir = Get-ChildItem -Path "C:\Program Files", "C:\Users\runneradmin\AppData\Local" -Filter "MEGAcmd" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
        if ($megaDir) { $env:PATH += ";$megaDir" }
        
        try { mega-login ${{ secrets.MEGA_EMAIL }} ${{ secrets.MEGA_PASSWORD }} } catch { Write-Host "Login check..." }

        # Incercam descarcarea
        try { mega-get /RDP_Full_Backup/FullProfile.7z C:\FullProfile.7z } catch { Write-Host "Nu exista backup (ok)." }

        if (Test-Path "C:\FullProfile.7z") {
            Write-Host "Backup gasit! Se dezarhiveaza..."
            # Extragem in C:\Users (va suprascrie folderul runneradmin)
            & "7z" x "C:\FullProfile.7z" -o"C:\Users\" -aoa -y
            
            $msg = @{ content = "RESTAURARE REUSITA!" } | ConvertTo-Json
            Invoke-RestMethod -Uri ${{ secrets.DISCORD_WEBHOOK }} -Method Post -Body $msg -ContentType "application/json"
        }
        
        $global:LastExitCode = 0
        exit 0

    # 3. LOOP BACKUP TOTAL (REPARAT PATH + 7ZIP)
    - name: Loop Backup Total
      shell: powershell
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # --- FIX MEGA PATH: Il punem din nou aici ca sa fim siguri ca merge ---
        $megaDir = Get-ChildItem -Path "C:\Program Files", "C:\Users\runneradmin\AppData\Local" -Filter "MEGAcmd" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
        if ($megaDir) { 
            $env:PATH += ";$megaDir"
            Write-Host "MEGA Path setat corect: $megaDir"
        }

        $count = 0
        while($count -lt 300) {
            Start-Sleep -Seconds 600
            $count++
            
            Write-Host "Incepere backup nr. $count..."

            if (Test-Path "C:\FullProfile.7z") { Remove-Item "C:\FullProfile.7z" -Force }
            
            # --- FIX 7ZIP: Arhivam folderul intreg, nu cu steluta ---
            # -ssw = copiaza fisiere blocate
            # 2> $null = ascunde erorile rosii
            & "7z" a "C:\FullProfile.7z" "C:\Users\runneradmin" -mx1 -ssw -xr!AppData\Local\Temp -xr!AppData\Local\MEGAcmd 2> $null
            
            if (Test-Path "C:\FullProfile.7z") {
                $size = (Get-Item "C:\FullProfile.7z").Length
                Write-Host "Arhiva creata. Marime: $size bytes"
                
                if ($size -gt 1000) {
                    # Stergem vechiul backup folosind calea sigura
                    mega-rm /RDP_Full_Backup/FullProfile.7z
                    mega-put -c C:\FullProfile.7z /RDP_Full_Backup/
                    
                    $alert = @{ content = "[BACKUP] Salvarea nr. $count reusita." } | ConvertTo-Json
                    Invoke-RestMethod -Uri ${{ secrets.DISCORD_WEBHOOK }} -Method Post -Body $alert -ContentType "application/json"
                } else {
                   Write-Host "Arhiva e prea mica (goala), nu o urcam."
                }
            } else {
                Write-Host "Eroare la crearea arhivei."
            }
        }
